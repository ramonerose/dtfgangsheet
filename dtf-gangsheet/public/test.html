<!DOCTYPE html>
<html>
<head>
  <title>Upload PDF for Gang Sheet</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 22px; }
    .log { font-family: monospace; background: #f4f4f4; padding: 10px; border: 1px solid #ccc; margin-top: 10px; max-height: 200px; overflow-y: auto; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Upload PDF for Gang Sheet</h1>
  
  <form id="uploadForm">
    <label>Select PDF file:</label>
    <input type="file" id="fileInput" name="file" accept="application/pdf" required>
    <br><br>
    
    <label>Quantity:</label>
    <input type="number" id="qtyInput" name="qty" value="10" required>
    <br><br>
    
    <label>Rotate 90¬∞?</label>
    <select id="rotateInput" name="rotate">
      <option value="0">No</option>
      <option value="90">Yes</option>
    </select>
    <br><br>
    
    <button type="submit">Generate Gang Sheet</button>
  </form>
  
  <div id="status" class="log hidden"></div>
  <div id="result" class="hidden"></div>

  <script>
    const form = document.getElementById("uploadForm");
    const statusDiv = document.getElementById("status");
    const resultDiv = document.getElementById("result");

    function logMessage(msg, type = "info") {
      const timestamp = new Date().toLocaleTimeString();
      const color = type === "error" ? "red" : type === "success" ? "green" : "black";
      statusDiv.innerHTML += `<div style="color:${color}">[${timestamp}] ${msg}</div>`;
      statusDiv.classList.remove("hidden");
      statusDiv.scrollTop = statusDiv.scrollHeight;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      statusDiv.innerHTML = "";
      resultDiv.innerHTML = "";
      resultDiv.classList.add("hidden");
      
      logMessage("üì§ Preparing upload...");

      const fileInput = document.getElementById("fileInput").files[0];
      const qty = document.getElementById("qtyInput").value;
      const rotate = document.getElementById("rotateInput").value;

      if (!fileInput) {
        logMessage("‚ùå No file selected!", "error");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput);

      logMessage(`‚û°Ô∏è Sending file: ${fileInput.name}`);
      logMessage(`‚û°Ô∏è Quantity: ${qty}, Rotate: ${rotate}`);

      try {
        const response = await fetch(`/merge?qty=${qty}&rotate=${rotate}`, {
          method: "POST",
          body: formData
        });

        logMessage("‚úÖ Server responded, checking response headers...");

        if (!response.ok) {
          logMessage(`‚ùå Server error: ${response.statusText}`, "error");
          resultDiv.innerHTML = `<p class="error">‚ùå Failed to generate gang sheet.</p>`;
          resultDiv.classList.remove("hidden");
          return;
        }

        const contentDisposition = response.headers.get("Content-Disposition");
        const contentType = response.headers.get("Content-Type");
        logMessage(`üìÑ Response Content-Type: ${contentType}`);
        logMessage(`üìÑ Response Content-Disposition: ${contentDisposition}`);

        const blob = await response.blob();

        // Detect if it's a ZIP or single PDF
        let filename = "gangsheet.pdf";
        if (contentDisposition && contentDisposition.includes("filename=")) {
          filename = contentDisposition.split("filename=")[1].replace(/"/g, "");
        }

        logMessage(`‚¨áÔ∏è Ready to download: ${filename}`, "success");

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.textContent = `Click here to download ${filename}`;
        resultDiv.innerHTML = "";
        resultDiv.appendChild(a);
        resultDiv.classList.remove("hidden");
      } catch (err) {
        logMessage(`‚ùå JS Fetch error: ${err.message}`, "error");
        resultDiv.innerHTML = `<p class="error">‚ùå Failed to generate gang sheet.</p>`;
        resultDiv.classList.remove("hidden");
      }
    });
  </script>
</body>
</html>
