<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload PDF for Gang Sheet</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .log { margin-top: 15px; padding: 10px; border: 1px solid #ccc; }
    .result { margin-top: 15px; padding: 10px; background: #f7f7f7; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Upload PDF for Gang Sheet</h1>

  <form id="uploadForm">
    <label>Select PDF file:</label>
    <input type="file" name="file" required><br><br>

    <label>Quantity:</label>
    <input type="number" name="quantity" required><br><br>

    <label>Rotate 90¬∞?</label>
    <select name="rotate">
      <option value="false">No</option>
      <option value="true">Yes</option>
    </select><br><br>

    <button type="submit">Generate Gang Sheet</button>
  </form>

  <div class="log" id="log"></div>
  <div class="result" id="result"></div>

  <script>
    const form = document.getElementById("uploadForm");
    const logDiv = document.getElementById("log");
    const resultDiv = document.getElementById("result");

    function log(message) {
      logDiv.innerHTML += `<div>${message}</div>`;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      logDiv.innerHTML = "";
      resultDiv.innerHTML = "";

      const formData = new FormData(form);
      log("‚è≥ Uploading...");

      const response = await fetch("/merge", { method: "POST", body: formData });
      const data = await response.json();

      if (data.type === "single") {
        log("‚úÖ Single sheet generated!");
        const blob = b64toBlob(data.pdf, "application/pdf");
        const url = URL.createObjectURL(blob);

        resultDiv.innerHTML = `
          <p><strong>Sheet Size:</strong> 22x${data.sheetHeight} inches</p>
          <p><strong>Cost:</strong> $${data.cost.toFixed(2)}</p>
          <a href="${url}" download="${data.filename}">‚¨áÔ∏è Download PDF</a>
        `;
      } else if (data.type === "multi") {
        log(`‚úÖ ${data.sheets.length} sheets generated!`);

        let html = "<h3>Sheets:</h3>";
        data.sheets.forEach((s, idx) => {
          const sheetData = data.zipSheets[idx];
          const blob = b64toBlob(sheetData.pdf, "application/pdf");
          const url = URL.createObjectURL(blob);

          html += `
            <div>
              üìè 22x${s.height} ‚Üí üí∞ $${s.cost.toFixed(2)}
              <a href="${url}" download="${sheetData.filename}">‚¨áÔ∏è Download</a>
            </div>
          `;
        });
        html += `<p><strong>Total Cost:</strong> $${data.totalCost.toFixed(2)}</p>`;
        resultDiv.innerHTML = html;
      } else {
        log("‚ùå Unexpected response");
      }
    });

    function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
      const byteCharacters = atob(b64Data);
      const byteArrays = [];
      for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
      return new Blob(byteArrays, { type: contentType });
    }
  </script>
</body>
</html>
