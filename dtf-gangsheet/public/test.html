<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EZ Gang Sheets</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .drop-zone {
      border: 2px dashed #cbd5e1;
      transition: border 0.3s ease;
    }
    .drop-zone.dragover {
      border-color: #3b82f6;
      background-color: #f0f9ff;
    }
    /* ‚úÖ Circle spinner */
    .spinner {
      width: 32px;
      height: 32px;
      border: 4px solid #e5e7eb; /* light gray */
      border-top: 4px solid #3b82f6; /* blue */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Logo -->
  <div class="flex flex-col items-center mt-6">
    <img src="EZGangSheetsLogo.png" alt="EZGangSheets Logo" class="w-[256px]">
  </div>

  <div class="max-w-lg mx-auto bg-white shadow-md rounded-lg p-6 mt-6">

    <!-- Drag & Drop Zone -->
    <div id="dropZone" class="drop-zone rounded-lg p-6 text-center cursor-pointer hover:border-blue-500">
      <div class="flex flex-col items-center">
        <!-- ‚úÖ Blue cloud upload icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 0117 8a4 4 0 01.88 7.903M12 12v9m0-9l-3 3m3-3l3 3" />
        </svg>
        <p class="font-semibold text-gray-700">Drag & drop your PDF here</p>
        <p class="text-sm text-gray-500">or click to browse</p>
      </div>
      <input type="file" id="file" accept="application/pdf" class="hidden">
    </div>

    <!-- Thumbnail Preview -->
    <div id="filePreview" class="hidden mt-4 text-center">
      <p id="fileName" class="text-green-700 font-medium"></p>
      <canvas id="pdfThumb" class="mx-auto mt-3 rounded shadow" style="max-height:180px;"></canvas>
    </div>

    <!-- Form Fields -->
    <label class="block mt-4 font-semibold">Quantity</label>
    <input type="number" id="quantity" min="1" class="border rounded w-full p-2" required>

    <label class="block mt-4 font-semibold">Rotate 90¬∞?</label>
    <select id="rotate" class="border rounded w-full p-2">
      <option value="false">No</option>
      <option value="true">Yes</option>
    </select>

    <label class="block mt-4 font-semibold">Gang Sheet Width</label>
    <select id="gangWidth" class="border rounded w-full p-2">
      <option value="22" selected>22 inches</option>
      <option value="30">30 inches</option>
    </select>

    <label class="block mt-4 font-semibold">Max Sheet Length (inches)</label>
    <input type="number" id="maxLength" min="12" value="200" class="border rounded w-full p-2">

    <button id="generateBtn" class="w-full bg-blue-600 text-white mt-6 py-2 rounded hover:bg-blue-700 transition">
      Generate Gang Sheet
    </button>
  </div>

  <!-- Results -->
  <div id="log" class="max-w-lg mx-auto mt-6"></div>

  <!-- PDF.js for Thumbnails -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

  <script>
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("file");
    const filePreview = document.getElementById("filePreview");
    const fileNameEl = document.getElementById("fileName");
    const pdfThumb = document.getElementById("pdfThumb");

    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) showPreview(file);
    });
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (file) showPreview(file);
    });

    async function showPreview(file) {
      fileNameEl.textContent = `‚úÖ Selected: ${file.name}`;
      filePreview.classList.remove("hidden");

      const reader = new FileReader();
      reader.onload = async function() {
        const typedArray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 0.3 });
        const context = pdfThumb.getContext('2d');
        pdfThumb.width = viewport.width;
        pdfThumb.height = viewport.height;
        await page.render({ canvasContext: context, viewport }).promise;
      };
      reader.readAsArrayBuffer(file);
    }

    document.getElementById("generateBtn").addEventListener("click", async () => {
      const logDiv = document.getElementById("log");
      const file = fileInput.files[0];
      const quantity = document.getElementById("quantity").value;
      const rotate = document.getElementById("rotate").value;
      const gangWidth = document.getElementById("gangWidth").value;
      const maxLength = document.getElementById("maxLength").value;

      if (!file) {
        alert("Please select a PDF first!");
        return;
      }

      // ‚úÖ Show circle spinner while generating
      logDiv.innerHTML = `
        <div class="flex flex-col items-center">
          <div class="spinner"></div>
          <p class="text-blue-600 font-semibold mt-2">Generating gang sheet...</p>
        </div>
      `;

      const formData = new FormData();
      formData.append("file", file);
      formData.append("quantity", quantity);
      formData.append("rotate", rotate);
      formData.append("gangWidth", gangWidth);
      formData.append("maxLength", maxLength);

      const response = await fetch("/merge", {
        method: "POST",
        body: formData
      });

      if (!response.ok) {
        logDiv.innerHTML = `<p class="text-red-600 font-semibold text-center">‚ùå Server error! Please try again.</p>`;
        return;
      }

      const data = await response.json();

      let html = `
        <p class="text-green-600 font-bold flex items-center">
          ‚úÖ Sheets ready!
        </p>
        <div class="mt-4 space-y-3">
      `;

      data.sheets.forEach((s) => {
        html += `
          <div class="flex justify-between items-center p-3 border rounded bg-gray-50 shadow-sm">
            <div class="flex items-center space-x-2">
              üìÑ <span class="font-medium">${s.filename}</span>
            </div>
            <div class="flex items-center space-x-4">
              <span class="text-green-700 font-bold">$${s.cost.toFixed(2)}</span>
              <a href="data:application/pdf;base64,${s.pdfBase64}" download="${s.filename}" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">‚¨áÔ∏è Download</a>
            </div>
          </div>
        `;
      });

      html += `
        </div>
        <div class="mt-6 p-4 bg-green-100 rounded text-center font-bold text-lg">
          Summary: Total Cost $${data.totalCost.toFixed(2)}
        </div>
      `;

      logDiv.innerHTML = html;
    });
  </script>
</body>
</html>
