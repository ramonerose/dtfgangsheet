<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gang Sheet Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    h1 {
      font-size: 22px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <h1>Upload PDF for Gang Sheet</h1>

  <form id="gangForm" enctype="multipart/form-data">
    <!-- PDF upload -->
    <label>Select PDF file:</label>
    <input type="file" id="file" name="file" accept=".pdf" required>

    <!-- Quantity -->
    <label>Quantity:</label>
    <input type="number" id="qty" name="qty" min="1" value="10" required>

    <!-- Rotation yes/no -->
    <label>Rotate 90°?</label>
    <select id="rotate" name="rotate">
      <option value="0">No</option>
      <option value="90">Yes, rotate 90°</option>
    </select>

    <br><br>
    <button type="submit">Generate Gang Sheet</button>
  </form>

  <div id="status" style="margin-top:20px; color:blue;"></div>

  <script>
    document.getElementById("gangForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const fileInput = document.getElementById("file");
      const qty = document.getElementById("qty").value;
      const rotate = document.getElementById("rotate").value;

      if (!fileInput.files.length) {
        alert("Please select a PDF file!");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      const statusDiv = document.getElementById("status");
      statusDiv.innerHTML = "⏳ Generating gang sheet... please wait.";

      try {
        const response = await fetch(`/merge?qty=${qty}&rotate=${rotate}`, {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          statusDiv.innerHTML = "❌ Failed to generate gang sheet.";
          return;
        }

        // ✅ If PDF, trigger download
        const blob = await response.blob();
        const filename = response.headers.get("Content-Disposition")
          ?.split("filename=")[1]
          ?.replace(/"/g, "") || "gangsheet.pdf";

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        statusDiv.innerHTML = `✅ Gang sheet generated: <strong>${filename}</strong>`;
      } catch (err) {
        console.error(err);
        statusDiv.innerHTML = "❌ Error generating gang sheet.";
      }
    });
  </script>
</body>
</html>
